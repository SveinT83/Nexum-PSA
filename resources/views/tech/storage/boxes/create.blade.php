# tech.storage.boxes.create / tech.storage.boxes.edit — View Specification (Storage Box Form)

**Creation date:** 2025-10-29
**URL(s):** `tech.storage.boxes.create`, `tech.storage.boxes.edit:{boxId}`
**Access levels:** `storage.manage` (view + save), `storage.view` (read-only fallback)
**Controller (HTTP):** `App\Http\Controllers\Tech\Storage\Boxes\EditController@form` (GET), `@save` (POST)
**Livewire/Components:** `App\Livewire\Tech\Storage\Boxes\Form`
**Status:** Not started
**Difficulty:** Low–Medium
**Estimated time:** 1.5 hours

---

## Purpose

Create and edit **Boxes** (logical containers) bound to a **Warehouse**. Supports barcode/QR from day one and fast printing to thermal 58×40 mm. The form is shared for create/edit with small behavioral differences.

---

## Layout (Bootstrap)

Static regions: **Top header** / **Main content** / **Right slim rail**.

* **Top header**

  * Title: "New Box" / "Edit Box #{id}"
  * Breadcrumb: Storage → Boxes → Create/Edit
  * Actions (right): **Save**, **Save & Print Label**, **Close** (and **Delete** on edit)

* **Main content** (form)

  1. **Identity & Location** (card)

     * **Warehouse** (required, select)
     * **Box ID** (read-only on edit; on create shows “will be assigned after save”)
     * **Human Code** (optional, unique per tenant)
     * **Name** (optional)
     * **Status** (enum: in_stock, in_transit, loaned, at_customer, lost, retired)
     * **Placement note** (free text; e.g., "aisle B, top shelf" / "van")
     * **Active** (toggle)

  2. **Barcode / Label** (card)

     * **Barcode value** (defaults to generated Box ID on first save; editable)
     * **Barcode type** (QR, EAN13, CODE128; default QR)
     * **Label preview** (live preview widget)
     * **Print target** (dropdown: Thermal 58×40 mm (default), A4 fallback)

  3. **Audit (read-only)** — *only on edit*

     * Created by / at, Updated by / at
     * Last event: type & timestamp (from BoxEvent)

* **Right slim rail**

  * **Quick actions**: Move (opens move modal), Change Status, Print Label
  * **Conflicts** (widget): warns if contained items are reserved/open on orders
  * **Tips**: Scan-to-open hint, barcode best practices

**Suggested icons:** box, qrcode, printer, map-pin, move, toggle-right, alert-triangle, history.

---

## Fields & Validation

| Field          | Type             | Rules                                                       |                           |
| -------------- | ---------------- | ----------------------------------------------------------- | ------------------------- |
| warehouse_id   | select           | **required**; must be existing & active warehouse           |                           |
| id (display)   | text (read-only) | generated by DB; shown after first save                     |                           |
| code_human     | text             | max 32; tenant-unique; slug-like (A–Z, 0–9, -, _); optional |                           |
| name           | text             | max 120; optional                                           |                           |
| status         | enum             | required; default `in_stock` on create                      |                           |
| placement_note | textarea         | max 512; optional                                           |                           |
| is_active      | boolean          | default true                                                |                           |
| barcode_value  | text             | required after first save; default to Box ID if empty       |                           |
| barcode_type   | enum             | QR (default)                                                | EAN13 (13-digit), CODE128 |
| print_target   | enum             | Thermal58x40 (default)                                      | A4                        |

**Server-side normalization**

* `code_human` → uppercase, collapse spaces to `-`.
* When `barcode_type = EAN13`, enforce 13 digits + compute/check checksum.

**Uniqueness**

* `code_human` unique **per tenant**.
* `barcode_value` unique **per tenant**.

---

## Actions & Buttons

* **Save** — persists changes; stays on page; toasts “Saved”.
* **Save & Print Label** — save then trigger label generation (PDF) for **Thermal 58×40 mm** by default; opens print dialog/new tab.
* **Close** — navigate back to `tech.storage.boxes.index` or previous.
* **Delete** *(edit only, permission: `storage.manage` + policy)* — soft-delete box if empty (no items) and not reserved/in transit.

**Keyboard**

* `Ctrl/Cmd + S` Save
* `Ctrl/Cmd + P` Save & Print Label
* `Esc` Close (with unsaved changes guard)

---

## Behaviors (Create vs Edit)

* **Create**

  * Box ID is not visible until after first save.
  * If `barcode_value` left empty → system sets to new Box ID.
  * After save, show toast with **Scan hint** ("Scan label to open this box").

* **Edit**

  * Box ID shown (read-only).
  * Allow changing `barcode_value`/`type` with uniqueness & checksum checks.
  * Show **Audit** and **Last event** summary.

---

## Form Events → Domain Effects

* On **Save**

  * Write Box row; upsert uniqueness indexes.
  * Emit `box.renamed` if `name` or `code_human` changed (BoxEvent `renamed`).
  * Emit `box.status_changed` if status toggled.
  * Write action to system audit log (who/what/when; before/after).

* On **Save & Print Label**

  * As above, then call Label service with: `{id, name, code_human, warehouse.name, barcode_value, barcode_type, format: Thermal58x40}`.

* On **Delete** *(edit)*

  * Guard: deny if items exist or any contained item is reserved/loaned/in_transit.
  * Soft-delete, emit BoxEvent `retired`.

---

## Label Spec (Thermal 58×40 mm)

* Layout: QR/Barcode left; text stack right.
* Text lines: **BOX #{id}** (bold), `name` (if set), `warehouse.code/name`, `code_human` (if set).
* Quiet zone respected; automatic scaling for long names.
* Fallback: A4 single-label PDF (centered) when target changed.

---

## Widgets & Reusable Components

* **LabelPreview** (live): renders QR/Code128/EAN13 with current value.
* **ConflictHints**: reads reservations for items in this box and shows warnings.
* **AuditMini**: small, read-only timeline for last 5 BoxEvents.

---

## Permissions & Policies

* Page requires `storage.manage` for edit/save; users with only `storage.view` see read-only version (no buttons).
* Delete additionally checks policy: `box.canDelete(user)` (must be empty and not reserved/in transit).

---

## Error States & UX

* **Duplicate barcode_value** → inline error; suggest next free value.
* **Invalid EAN13** → checksum error.
* **Warehouse disabled** → block save with clear message.
* **Print service unavailable** → save succeeds; show warning toast with link to download PDF.

---

## Right Rail Quick Actions (contextual)

* **Move Box** → routes to `tech.storage.boxes.move:{boxId}` (or opens move modal).
* **Change Status** → inline dropdown + confirm.
* **Print Label** → direct call to Label service (no save if unchanged).

---

## Logging & Audit

* Every save/delete writes a system **Action Log** and a **BoxEvent** row with before/after diff in metadata.
* Include actor, timestamp, reason (optional), and originating controller/method.

---

## Testing Checklist

* Create → Save assigns ID; barcode defaults to ID.
* Edit name/status → BoxEvent emitted and visible in show/audit.
* Duplicate barcode blocked.
* EAN13 validation works.
* Save & Print produces 58×40 PDF with correct data; opens in new tab.
* Delete prevented when items exist or reservations present.

---

## Notes for Developers & Copilot

* View file name convention: `boxes/create.blade.php` (shared for edit) **or** Livewire `Boxes/Form` mounted by route.
* Keep form components reusable; LabelPreview used also in `boxes.show`.
* Use debounce on inputs that update preview (200ms).
* Real-time: reflect external status changes via websockets if another user moves/changes the box while this form is open.
